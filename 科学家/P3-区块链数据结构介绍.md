# 区块链数据结构层级介绍

区块，交易，日志

区块包含多个交易，交易包含多个日志

## 区块

由区块头和交易列表组成

区块头：包含高度、时间戳、哈希、上个区块哈希等元信息

## 交易

- 转 ETH，不包含 input data
- 转 ERC20 代币，调用智能合约（给智能合约的 0 ETH转账），input data 为函数调用

和网银转账一致的地方：

- 交易的发起方
- 交易的接收方
- 交易的金额

和网银转账不一致的地方：

- 交易的金额可以是 0
- 可以包含可执行的指令 

特点：

- 和区块链交互的最小单位，交互会产生交易
- 可以很简单，也可以执行很复杂的逻辑
- VALUE不一定代表实际的交易价值（例如和 DEX 交互）

## 日志

记录了智能合约调用中，触发的事件


区块链浏览器，Logs 页面，例如[这个页面](https://etherscan.io/tx/0xeebae52adc354d79f305d53d7317d184b145c79ba53ca2a79a81bb767c6e97dc#eventlog)

该日志记录了一次 ERC20 转账事件：

``` javascript
event Transfer(address indexed from, address indexed to, uint tokens);
```

包含以下结构：

- Address： 智能合约的地址
- Name：事件的函数签名，由浏览器反推出来的，并不存储在日志中
- Topics：一个数组
  - `Topics[0]`: Name 中的事件哈希，即 `Topics[0] = hash("Transfer(address,address,uint256)")`
  - `Topics[1]` 为 `from` 参数
  - `Topics[2]` 为 `to` 参数
- Data：包含了 `tokens`，由于 `tokens` 不带有 `indexed` 属性，因此被记录在 Data 中

日志和事件的意义：由于对智能合约的调用会更改区块链状态，智能合约的开发者通过事件来方便大家跟踪这些状态更改，
  例如一个商家可以根据 USDT 的 Transfer 事件来得知收款到账

日志的查询和利用：获取某个 ERC20 代币的转账历史等

日志的重要性：日志提供了一种低成本的状态跟踪机制，同时由于日志存储在区块链上，因此具有可追踪和不可篡改的性质，对于科学家非常重要，
但是由于日志都是开发者自己定义的，有些土狗甚至会伪造 Transfer 事件

## 区块链数据结构当中的一些问题

区块链中的时间：区块链中最小的时间精度是一个区块，因此时间是离散的，交易没有独立的时间

区块中交易不是按时间顺序，不是先提交先确认，而是按矿工的排序方式

一次交易可以实现不只一次操作，可以包含很多次，斯巴达闪电贷 500+ 次操作

日志中的数据从区块链读出来，也未必是区块链浏览器中人类可读的样子，要有智能合约 abi

# 区块链的数据流转

1. 构造交易：`build_transaction`，生成交易请求
2. 交易签名：`sign_transaction`，对交易请求签名
3. 广播交易：`send_raw_transaction`
4. 区块链网络收到交易，并存储在区块链
5. 区块链网络发送交易回执
6. 用户等待交易回执：`wait_for_transaction_receipt`

广播出去不等于上链, 交易请求和交易回执是两个不同视角

矿工视角，两个进程：

进程1
1. 把池子里的交易打包，计算哈希
2. 获得记账权
3. 广播获得的记账权
4. 按照交易打包顺序执行

进程2
1. 监听网络，捕获交易
2. 放入缓存池子，并排序